let e=(t={},n=require("underscore"),function(){function e(e,r){r=r||{json:function(){throw"json() unsupported for type "+this.type}};var t={json:function(t){var a=r.json.call(this,t);return a.r_type=e,n.isUndefined(this.attributes)||(a.r_attributes=n.object(n.map(this.attributes.value,(function(e){return[e.name,e.value.json(t)]})))),a}};return function(r,n){function a(){this.type=e,this.value=r,this.attributes=n}return a.prototype=t,new a}}t.Robj={null:function(e){return{type:"null",value:null,attributes:e,json:function(){return null}}},clos:function(e,r,t){return{type:"clos",value:{formals:e,body:r},attributes:t,json:function(){throw"json() unsupported for type clos"}}},vector:e("vector",{json:function(e){var r=n.map(this.value,(function(r){return r.json(e)}));if(n.isUndefined(this.attributes))return r;if("names"==this.attributes.value[0].name){var t=this.attributes.value[0].value.value,a={};return n.each(t,(function(e,t){a[e]=r[t]})),a}return r}}),symbol:e("symbol",{json:function(){return this.value}}),list:e("list"),lang:e("lang",{json:function(e){var r=n.map(this.value,(function(r){return r.json(e)}));if(n.isUndefined(this.attributes))return r;if("names"!=this.attributes.value[0].name)throw"expected names here";var t=this.attributes.value[0].value.value,a={};return n.each(t,(function(e,t){a[e]=r[t]})),a}}),tagged_list:e("tagged_list",{json:function(e){var r=this.value.slice(1);switch(function(e){return n.all(e,(function(e){return null===e.name}))?"plain_list":n.all(e,(function(e){return null!==e.name}))?"plain_object":"mixed_list"}(r)){case"plain_list":return n.map(r,(function(r){return r.value.json(e)}));case"plain_object":return n.object(n.map(r,(function(r){return[r.name,r.value.json(e)]})));case"mixed_list":return r;default:throw"Internal Error"}}}),tagged_lang:e("tagged_lang",{json:function(e){return n.map(this.value,(function(r){return[r.name,r.value.json(e)]}))}}),vector_exp:e("vector_exp"),int_array:e("int_array",{json:function(){if(this.attributes&&"tagged_list"===this.attributes.type&&"levels"===this.attributes.value[0].name&&"string_array"===this.attributes.value[0].value.type){var e=this.attributes.value[0].value.value,r=n.map(this.value,(function(r){return e[r-1]}));return r.levels=e,r}return 1===this.value.length?this.value[0]:this.value}}),double_array:e("double_array",{json:function(){return 1===this.value.length&&n.isUndefined(this.attributes)?this.value[0]:this.value}}),string_array:e("string_array",{json:function(e){return 1===this.value.length?n.isUndefined(this.attributes)?this.value[0]:"class"===this.attributes.value[0].name&&-1!==this.attributes.value[0].value.value.indexOf("javascript_function")?e(this.value[0]):this.value:this.value}}),bool_array:e("bool_array",{json:function(){return 1===this.value.length&&n.isUndefined(this.attributes)?this.value[0]:this.value}}),raw:e("raw",{json:function(){return 1===this.value.length&&n.isUndefined(this.attributes)?this.value[0]:this.value}}),string:e("string",{json:function(){return this.value}})}}(),t.Rsrv={PAR_TYPE:function(e){return 255&e},PAR_LEN:function(e){return e>>>8},PAR_LENGTH:function(e){return e>>>8},par_parse:function(e){return[t.Rsrv.PAR_TYPE(e),t.Rsrv.PAR_LEN(e)]},SET_PAR:function(e,r){return(16777215&r)<<8|255&e},CMD_STAT:function(e){return e>>>24&127},SET_STAT:function(e,r){return e|(127&r)<<24},IS_OOB_SEND:function(e){return(268431360&e)===t.Rsrv.OOB_SEND},IS_OOB_MSG:function(e){return(268431360&e)===t.Rsrv.OOB_MSG},OOB_USR_CODE:function(e){return 4095&e},CMD_RESP:65536,RESP_OK:65537,RESP_ERR:65538,OOB_SEND:135168,OOB_MSG:139264,ERR_auth_failed:65,ERR_conn_broken:66,ERR_inv_cmd:67,ERR_inv_par:68,ERR_Rerror:69,ERR_IOerror:70,ERR_notOpen:71,ERR_accessDenied:72,ERR_unsupportedCmd:73,ERR_unknownCmd:74,ERR_data_overflow:75,ERR_object_too_big:76,ERR_out_of_mem:77,ERR_ctrl_closed:78,ERR_session_busy:80,ERR_detach_failed:81,ERR_disabled:97,ERR_unavailable:98,ERR_cryptError:99,ERR_securityClose:100,CMD_login:1,CMD_voidEval:2,CMD_eval:3,CMD_shutdown:4,CMD_switch:5,CMD_keyReq:6,CMD_secLogin:7,CMD_OCcall:15,CMD_openFile:16,CMD_createFile:17,CMD_closeFile:18,CMD_readFile:19,CMD_writeFile:20,CMD_removeFile:21,CMD_setSEXP:32,CMD_assignSEXP:33,CMD_detachSession:48,CMD_detachedVoidEval:49,CMD_attachSession:50,CMD_ctrl:64,CMD_ctrlEval:66,CMD_ctrlSource:69,CMD_ctrlShutdown:68,CMD_setBufferSize:129,CMD_setEncoding:130,CMD_SPECIAL_MASK:240,CMD_serEval:245,CMD_serAssign:246,CMD_serEEval:247,DT_INT:1,DT_CHAR:2,DT_DOUBLE:3,DT_STRING:4,DT_BYTESTREAM:5,DT_SEXP:10,DT_ARRAY:11,DT_LARGE:64,XT_NULL:0,XT_INT:1,XT_DOUBLE:2,XT_STR:3,XT_LANG:4,XT_SYM:5,XT_BOOL:6,XT_S4:7,XT_VECTOR:16,XT_LIST:17,XT_CLOS:18,XT_SYMNAME:19,XT_LIST_NOTAG:20,XT_LIST_TAG:21,XT_LANG_NOTAG:22,XT_LANG_TAG:23,XT_VECTOR_EXP:26,XT_VECTOR_STR:27,XT_ARRAY_INT:32,XT_ARRAY_DOUBLE:33,XT_ARRAY_STR:34,XT_ARRAY_BOOL_UA:35,XT_ARRAY_BOOL:36,XT_RAW:37,XT_ARRAY_CPLX:38,XT_UNKNOWN:48,XT_LARGE:64,XT_HAS_ATTR:128,BOOL_TRUE:1,BOOL_FALSE:0,BOOL_NA:2,GET_XT:function(e){return 63&e},GET_DT:function(e){return 63&e},HAS_ATTR:function(e){return(e&t.Rsrv.XT_HAS_ATTR)>0},IS_LARGE:function(e){return(e&t.Rsrv.XT_LARGE)>0},status_codes:{65:"ERR_auth_failed",66:"ERR_conn_broken",67:"ERR_inv_cmd",68:"ERR_inv_par",69:"ERR_Rerror",70:"ERR_IOerror",71:"ERR_notOpen",72:"ERR_accessDenied",73:"ERR_unsupportedCmd",74:"ERR_unknownCmd",75:"ERR_data_overflow",76:"ERR_object_too_big",77:"ERR_out_of_mem",78:"ERR_ctrl_closed",80:"ERR_session_busy",81:"ERR_detach_failed",97:"ERR_disabled",98:"ERR_unavailable",99:"ERR_cryptError",100:"ERR_securityClose"}},function(){function e(e){var r={};function a(e,r){return function(t,n){return[e.call(u,t,n),r||n]}}function s(e,r){return function(t,n){var a=e.call(u,t,n),s=r(a[0])(t,n-a[1]);return[s[0],a[1]+s[1]]}}function i(e){if(1===e.length&&255===e.charCodeAt(0))return null;try{return decodeURIComponent(escape(e))}catch(r){throw new Error("Invalid UTF8: "+e)}}var o,u={offset:0,data_view:e.make(t.EndianAwareDataView),msg:e,read_int:function(){var e=this.offset;return this.offset+=4,this.data_view.getInt32(e)},read_string:function(e){for(var r="";e--;){var t=this.data_view.getInt8(this.offset++);t&&(r+=String.fromCharCode(t))}return i(r)},read_stream:function(e){var r=this.offset;return this.offset+=e,this.msg.view(r,e)},read_int_vector:function(e){var r=this.offset;return this.offset+=e,this.msg.make(Int32Array,r,e)},read_double_vector:function(e){var r=this.offset;return this.offset+=e,this.msg.make(Float64Array,r,e)},read_null:a((function(e,r){return t.Robj.null(e)})),read_unknown:a((function(e,r){return this.offset+=r,t.Robj.null(e)})),read_string_array:function(e,r){for(var n=this.read_stream(r).make(Uint8Array),a=[],s="",o=0;o<n.length;++o)0===n[o]?(s=i(s),a.push(s),s=""):s+=String.fromCharCode(n[o]);return[t.Robj.string_array(a,e),r]},read_bool_array:function(e,r){var a=this.read_int(),s=this.read_stream(r-4),i=n.map(s.make(Uint8Array).subarray(0,a),(function(e){return!!e}));return[t.Robj.bool_array(i,e),r]},read_raw:function(e,r){var n=this.read_int(),a=this.read_stream(r-4),s=new Uint8Array(a.make(Uint8Array).subarray(0,n)).buffer;return[t.Robj.raw(s,e),r]},read_sexp:function(){var e=this.read_int(),n=t.Rsrv.par_parse(e),a=n[0],s=n[1],i=4,o=void 0;if(t.Rsrv.IS_LARGE(a)&&(i+=4,s+=this.read_int()*Math.pow(2,24),a&=-65),a&t.Rsrv.XT_HAS_ATTR){a&=~t.Rsrv.XT_HAS_ATTR;var u=this.read_sexp();o=u[0],i+=u[1],s-=u[1]}if(void 0===r[a])throw new t.RserveError("Unimplemented "+a,-1);var _=r[a].call(this,o,s);return[_[0],i+_[1]]}};function _(e){for(var r=[],t=0;t<e.length;t+=2){var n=e[t],a=e[t+1];"symbol"===a.type?r.push({name:a.value,value:n}):r.push({name:null,value:n})}return r}function f(e,r){return s(e,(function(e){return a((function(t,n){return r(e,t)}),0)}))}function l(e,r){return a((function(t,n){return r(e.call(u,n),t)}))}return u.read_clos=s(u.read_sexp,(function(e){return s(u.read_sexp,(function(r){return a((function(n,a){return t.Robj.clos(e,r,n)}),0)}))})),u.read_list=(o=u.read_sexp,function(e,r){for(var t=[],n=r;r>0;){var a=o.call(u,e,r);t.push(a[0]),r-=a[1]}return[t,n]}),u.read_list_tag=s(u.read_list,(function(e){return a((function(r,n){var a=_(e);return t.Robj.tagged_list(a,r)}),0)})),u.read_lang_tag=s(u.read_list,(function(e){return a((function(r,n){var a=_(e);return t.Robj.tagged_lang(a,r)}),0)})),u.read_vector=f(u.read_list,t.Robj.vector),u.read_list_no_tag=f(u.read_list,t.Robj.list),u.read_lang_no_tag=f(u.read_list,t.Robj.lang),u.read_vector_exp=f(u.read_list,t.Robj.vector_exp),u.read_symname=l(u.read_string,t.Robj.symbol),u.read_int_array=l(u.read_int_vector,t.Robj.int_array),u.read_double_array=l(u.read_double_vector,t.Robj.double_array),r[t.Rsrv.XT_NULL]=u.read_null,r[t.Rsrv.XT_UNKNOWN]=u.read_unknown,r[t.Rsrv.XT_VECTOR]=u.read_vector,r[t.Rsrv.XT_CLOS]=u.read_clos,r[t.Rsrv.XT_SYMNAME]=u.read_symname,r[t.Rsrv.XT_LIST_NOTAG]=u.read_list_no_tag,r[t.Rsrv.XT_LIST_TAG]=u.read_list_tag,r[t.Rsrv.XT_LANG_NOTAG]=u.read_lang_no_tag,r[t.Rsrv.XT_LANG_TAG]=u.read_lang_tag,r[t.Rsrv.XT_VECTOR_EXP]=u.read_vector_exp,r[t.Rsrv.XT_ARRAY_INT]=u.read_int_array,r[t.Rsrv.XT_ARRAY_DOUBLE]=u.read_double_array,r[t.Rsrv.XT_ARRAY_STR]=u.read_string_array,r[t.Rsrv.XT_ARRAY_BOOL]=u.read_bool_array,r[t.Rsrv.XT_RAW]=u.read_raw,r[t.Rsrv.XT_STR]=l(u.read_string,t.Robj.string),u}var r=[],a=null,s=0,i=0;function o(){r=[],a=null,i=0,s=0}function u(r){var n=t.my_ArrayBufferView(r,16,r.byteLength-16);if(0===n.length)return null;var a=e(n),s=a.read_int(),i=t.Rsrv.par_parse(s),o=i[0],u=i[1];if(t.Rsrv.IS_LARGE(o)){if((u+=a.read_int()*Math.pow(2,24))>Math.pow(2,32))throw new Error("Payload too large: "+u+" bytes");o&=-65}if(o===t.Rsrv.DT_INT)return{type:"int",value:a.read_int()};if(o===t.Rsrv.DT_STRING)return{type:"string",value:a.read_string(u)};if(o===t.Rsrv.DT_BYTESTREAM)return{type:"stream",value:a.read_stream(u)};if(o===t.Rsrv.DT_SEXP){var _=(i=a.read_sexp())[0];return i[1],{type:"sexp",value:_}}throw new t.RserveError("Bad type for parse? "+o+" "+u,-1)}t.parse_websocket_frame=function(e){var n={};if(r.length){if(n.header=a,r.push(e),(i-=e.byteLength)<0)return n.ok=!1,n.message="Messages add up to more than expected length: got "+(s-i)+", expected "+s,o(),n;if(0!==i)return n.ok=!0,n.incomplete=!0,n;var _=new ArrayBuffer(s),f=new Uint8Array(_),l=0;if(r.forEach((function(e,r){f.set(new Uint8Array(e),l),l+=e.byteLength})),l!==s)return n.ok=!1,n.message="Internal error - frames added up to "+l+" not "+s,o(),n;o(),e=_}var c=new Int32Array(e,0,4),R=16777215&c[0],v=c[0]>>>24,d=c[1],h=c[3],g=c[2];if(n.header=[R,v,g],h)return n.ok=!1,n.message="rserve.js cannot handle messages larger than 4GB",n;var T=d+16;if(T>e.byteLength)return r.push(e),a=c,i=(s=T)-e.byteLength,n.header=c,n.ok=!0,n.incomplete=!0,n;if(R===t.Rsrv.RESP_ERR)return n.ok=!1,n.status_code=v,n.message="ERROR FROM R SERVER: "+(t.Rsrv.status_codes[v]||v)+" "+n.header[0]+" "+n.header[1]+" "+e.byteLength+" "+e,n;if(R!==t.Rsrv.RESP_OK&&!t.Rsrv.IS_OOB_SEND(R)&&!t.Rsrv.IS_OOB_MSG(R))return n.ok=!1,n.message="Unexpected response from Rserve: "+R+" status: "+t.Rsrv.status_codes[v],n;try{n.payload=u(e),n.ok=!0}catch(e){n.ok=!1,n.message=e.message}return n},t.parse_payload=u}(),function(){var e=new ArrayBuffer(4),t=new Uint8Array(e),n=new Uint32Array(e);if(t[0]=1,1===n[0])r=!0;else{if(16777216!==n[0])throw"we're bizarro endian, refusing to continue";r=!1}}(),t.EndianAwareDataView=function(){for(var e={setInt8:function(e,r){return this.view.setInt8(e,r)},setUint8:function(e,r){return this.view.setUint8(e,r)},getInt8:function(e){return this.view.getInt8(e)},getUint8:function(e){return this.view.getUint8(e)}},t=["setInt32","setInt16","setUint32","setUint16","setFloat32","setFloat64"],n=["getInt32","getInt16","getUint32","getUint16","getFloat32","getFloat64"],a=0;a<t.length;++a)e[s=t[a]]=function(e){return function(t,n){return this.view[e](t,n,r)}}(s);for(a=0;a<n.length;++a){var s;e[s=n[a]]=function(e){return function(t){return this.view[e](t,r)}}(s)}function i(e,r,t){void 0===r?0===e.byteLength?this.view={byteLength:0,byteOffset:0}:this.view=new DataView(e):this.view=new DataView(e,r,t)}return i.prototype=e,i}(),t.my_ArrayBufferView=function(e,r,a){return{buffer:e,offset:r=n.isUndefined(r)?0:r,length:a=n.isUndefined(a)?e.byteLength:a,data_view:function(){return new t.EndianAwareDataView(this.buffer,this.offset,this.buffer.byteLength-this.offset)},make:function(e,r,t){r=n.isUndefined(r)?0:r,t=n.isUndefined(t)?this.length:t;var a=e.BYTES_PER_ELEMENT||1,s=t/a;if((this.offset+r)%a!=0){for(var i=new DataView(this.buffer,this.offset+r,t),o=new ArrayBuffer(t),u=new DataView(o),_=0;_<t;++_)u.setUint8(_,i.getUint8(_));return new e(o)}return new e(this.buffer,this.offset+r,s)},skip:function(e){return t.my_ArrayBufferView(this.buffer,this.offset+e,this.buffer.byteLength)},view:function(e,r){var n=this.offset+e;if(n+r>this.buffer.byteLength)throw new Error("Rserve.my_ArrayBufferView.view: bounds error: size: "+this.buffer.byteLength+" offset: "+n+" length: "+r);return t.my_ArrayBufferView(this.buffer,n,r)}}},function(){function e(e,r,a){n.isArray(r)||(r=[r]),a||(a=0);var s=n.reduce(r,(function(e,r){return e+r.byteLength}),0),i=new ArrayBuffer(16+s),o=new t.EndianAwareDataView(i);o.setInt32(0,e),o.setInt32(4,s),o.setInt32(8,a),o.setInt32(12,0);var u=16;return n.each(r,(function(e){for(var r=new Uint8Array(e),t=0;t<r.byteLength;++t)o.setUint8(u+t,r[t]);u+=e.byteLength})),i}function r(e){var r=e.length+1+3&-4,n=new ArrayBuffer(r+4),a=new t.EndianAwareDataView(n);a.setInt32(0,t.Rsrv.DT_STRING+(r<<8));for(var s=0;s<e.length;++s)a.setInt8(4+s,e.charCodeAt(s));return n}t.create=function(a){var s=(a=n.defaults(a||{},{host:"http://127.0.0.1:8081",on_connect:function(){}})).host,i=a.on_connect,o=new WebSocket(s);o.binaryType="arraybuffer";var u,_=a.on_error||function(e){throw new t.RserveError(e,-1)},f=!1,l={};function c(e){var r=function(){var e;do{e=String(Math.random()).slice(2,12)}while(e in l);if(10!==e.length)throw new Error("Bad rng, no cookie");return e}();return l[r]=e,r}function R(e,r){var n,a=t.determine_size(e,r);if(a>16777215){var s=new ArrayBuffer(a+8);return(n=t.my_ArrayBufferView(s)).data_view().setInt32(0,t.Rsrv.DT_SEXP+(16777215&a)*Math.pow(2,8)+t.Rsrv.DT_LARGE),n.data_view().setInt32(4,a>>>24),t.write_into_view(e,n.skip(8),r,c),s}return s=new ArrayBuffer(a+4),(n=t.my_ArrayBufferView(s)).data_view().setInt32(0,t.Rsrv.DT_SEXP+(a<<8)),t.write_into_view(e,n.skip(4),r,c),s}function v(r,t,n){var s=e(r,t,n);return a.debug&&a.debug.message_out&&a.debug.message_out(s[0],r),o.send(s),s}o.onclose=function(e){u.running=!1,u.closed=!0,a.on_close&&a.on_close(e)},o.onmessage=function(e){if("Buffer"===e.data.constructor.name&&(e.data=new Uint8Array(e.data).buffer),a.debug&&a.debug.message_in&&a.debug.message_in(e),f)if("string"!=typeof e.data){var s=t.parse_websocket_frame(e.data);if(!s.incomplete){var o=s.header[2],l=16777215&s.header[0],c=n.find(g,(function(e){return e.msg_id==o}));if(c||(c=g[0]),s.ok)if(l===t.Rsrv.RESP_OK)c.result_callback(null,s.payload);else if(t.Rsrv.IS_OOB_SEND(l))a.on_data&&a.on_data(s.payload);else if(t.Rsrv.IS_OOB_MSG(l)){var T;c=t.Rsrv.OOB_USR_CODE(l)>255?h:d;try{T=t.wrap_all_ocaps(u,s.payload)}catch(e){return void v(t.Rsrv.RESP_ERR|l,r(String(e)),o)}if(n.isString(T[0]))n.isUndefined(a.on_oob_message)?v(t.Rsrv.RESP_ERR|l,r("No handler installed"),o):(c.in_oob_message=!0,a.on_oob_message(s.payload,(function(e,n){c.in_oob_message?(c.in_oob_message=!1,e?v(l|t.Rsrv.RESP_ERR,r(e),o):v(l|t.Rsrv.RESP_OK,r(n),o),A()):_("Don't call oob_message_handler more than once.")})));else if(n.isFunction(T[0]))if(u.ocap_mode){var p=T[0],E=T.slice(1);E.push((function(e,r){e?v(t.Rsrv.RESP_ERR|l,R(e),o):v(l,R(r),o)})),p.apply(void 0,E)}else v(t.Rsrv.RESP_ERROR|l,r("JavaScript function calls only allowed in ocap mode"),o);else v(t.Rsrv.RESP_ERROR|l,r("Unknown oob message type: "+typeof T[0]))}else _("Internal Error, parse returned unexpected type "+s.header[0],-1);else c.result_callback([s.message,s.status_code],void 0)}}else a.on_raw_string&&a.on_raw_string(e.data);else!function(e){if("string"==typeof(e=e.data))"Rsrv"!==e.substr(0,4)?_("server is not an RServe instance",-1):"0103"!==e.substr(4,4)?_("sorry, rserve only speaks the 0103 version of the R server protocol",-1):"QAP1"!==e.substr(8,4)?_("sorry, rserve only speaks QAP1",-1):(f=!0,a.login&&u.login(a.login),u.running=!0,i&&i.call(u));else{var r=new DataView(e),n=String.fromCharCode(r.getUint8(0))+String.fromCharCode(r.getUint8(1))+String.fromCharCode(r.getUint8(2))+String.fromCharCode(r.getUint8(3));"RsOC"===n?(f=!0,u.ocap_mode=!0,u.bare_ocap=t.parse_payload(e).value,u.ocap=t.wrap_ocap(u,u.bare_ocap),u.running=!0,i&&i.call(u)):_("Unrecognized server answer: "+n,-1)}}(e)};var d={queue:[],in_oob_message:!1,awaiting_result:!1,msg_id:0,name:"control"},h={queue:[],in_oob_message:!1,awaiting_result:!1,msg_id:1,name:"compute"},g=[d,h];function T(e){return!e.in_oob_message&&!e.awaiting_result&&e.queue.length}function A(){var e=n.filter(g,T);if(e.length)if(u.closed)_("Cannot send messages on a closed socket!",-1);else{var r=n.sortBy(e,(function(e){return e.queue[0].timestamp}))[0],t=r.queue.shift();r.result_callback=t.callback,r.awaiting_result=!0,a.debug&&a.debug.message_out&&a.debug.message_out(t.buffer,t.command),o.send(t.buffer)}}function p(r,t,n,a,s){return s||(s=g[0]),n=n||function(){},function(e,r,t,n){n.queue.push({buffer:e,callback:function(e,t){n.awaiting_result=!1,A(),r(e,t)},command:t,timestamp:Date.now()}),A()}(e(r,t,s.msg_id),n,a,s)}return u={ocap_mode:!1,running:!1,closed:!1,close:function(){o.close()},login:function(e,n){p(t.Rsrv.CMD_login,r(e),n,e)},eval:function(e,n){p(t.Rsrv.CMD_eval,r(e),n,e)},createFile:function(e,n){p(t.Rsrv.CMD_createFile,r(e),n,e)},writeFile:function(e,r){p(t.Rsrv.CMD_writeFile,function(e){var r=e.length,n=new ArrayBuffer(r+4),a=new t.EndianAwareDataView(n);a.setInt32(0,t.Rsrv.DT_BYTESTREAM+(r<<8));for(var s=0;s<e.length;++s)a.setInt8(4+s,e[s]);return n}(e),r,"")},closeFile:function(e){p(t.Rsrv.CMD_closeFile,new ArrayBuffer(0),e,"")},set:function(e,n,a){p(t.Rsrv.CMD_setSEXP,[r(e),R(n)],a,"")},OCcall:function(e,r,n){var a,s=!1;try{s|="OCref"===e.r_attributes.class,a=e[0]}catch(e){}if(!s)try{s|="OCref"===e.attributes.value[0].value.value[0],a=e.value[0]}catch(e){}if(s){var i=[a];i.push.apply(i,r);var o=64==a.charCodeAt(0)?h:d;p(t.Rsrv.CMD_OCcall,R(i,t.Rsrv.XT_LANG_NOTAG),n,"",o)}else n(new Error("Expected an ocap, instead got "+e),void 0)},wrap_ocap:function(e){return t.wrap_ocap(this,e)},resolve_hash:function(e){if(!(e in l))throw new Error("hash "+e+" not found.");return l[e]}}},t.wrap_all_ocaps=function(e,r){return function r(a){var s=a;if(n.isArray(a)&&a.r_attributes&&"OCref"==a.r_attributes.class)return t.wrap_ocap(e,a);if(n.isArray(a))(s=n.map(a,r)).r_type=a.r_type,s.r_attributes=a.r_attributes;else{if(n.isTypedArray(a))return a;if(n.isFunction(a))return a;if(a&&!n.isUndefined(a.byteLength)&&!n.isUndefined(a.slice))return a;n.isObject(a)&&(s=n.object(n.map(a,(function(e,t){return[t,r(e)]}))))}return s}(r=r.value.json(e.resolve_hash))},t.wrap_ocap=function(e,r){var a=function(){var a=n.toArray(arguments);if(!a.length||!n.isFunction(a[a.length-1]))throw new Error("forgot to pass continuation to ocap");var s=a.pop();e.OCcall(r,a,(function(r,a){n.isUndefined(a)||(a=t.wrap_all_ocaps(e,a)),s(r,a)}))};return a.bare_ocap=r,a}}(),t.RserveError=function(e,r){this.name="RserveError",this.message=e,this.status_code=r},t.RserveError.prototype=Object.create(Error),t.RserveError.prototype.constructor=t.RserveError,n.mixin({isTypedArray:function(e){return!!n.isObject(e)&&!n.isUndefined(e.byteLength)&&!n.isUndefined(e.BYTES_PER_ELEMENT)}}),t.type_id=function(e){if(n.isNull(e)||n.isUndefined(e))return t.Rsrv.XT_NULL;var r={boolean:t.Rsrv.XT_ARRAY_BOOL,number:t.Rsrv.XT_ARRAY_DOUBLE,string:t.Rsrv.XT_ARRAY_STR};if(!n.isUndefined(r[typeof e]))return r[typeof e];if(n.isTypedArray(e))return t.Rsrv.XT_ARRAY_DOUBLE;if(!n.isUndefined(e.byteLength)&&!n.isUndefined(e.slice))return t.Rsrv.XT_RAW;if(n.isArray(e)&&n.all(e,(function(e){return"string"==typeof e})))return t.Rsrv.XT_ARRAY_STR;if(n.isArray(e)&&n.all(e,(function(e){return"boolean"==typeof e})))return t.Rsrv.XT_ARRAY_BOOL;if(n.isArray(e))return t.Rsrv.XT_VECTOR;if(n.isFunction(e))return t.Rsrv.XT_ARRAY_STR|t.Rsrv.XT_HAS_ATTR;if(n.isObject(e))return t.Rsrv.XT_VECTOR|t.Rsrv.XT_HAS_ATTR;throw new t.RServeError("Value type unrecognized by Rserve: "+e)},t.determine_size=function(e,r){function a(e){return n.reduce(e,(function(e,r){return e+t.determine_size(r)}),0)}function s(e){return e>1<<24?e+8:e+4}var i=r||t.type_id(e);switch(i&~t.Rsrv.XT_LARGE){case t.Rsrv.XT_NULL:return s(0);case t.Rsrv.XT_ARRAY_BOOL:return n.isBoolean(e)?s(8):s(e.length+7&-4);case t.Rsrv.XT_ARRAY_STR:return n.isArray(e)?s(n.reduce(e,(function(e,r){return e+unescape(encodeURIComponent(r)).length+1}),0)):s(unescape(encodeURIComponent(e)).length+1);case t.Rsrv.XT_ARRAY_DOUBLE:return n.isNumber(e)?s(8):s(8*e.length);case t.Rsrv.XT_RAW:return s(4+e.byteLength);case t.Rsrv.XT_VECTOR:case t.Rsrv.XT_LANG_NOTAG:return s(a(e));case t.Rsrv.XT_VECTOR|t.Rsrv.XT_HAS_ATTR:var o=s("names".length+3),u=s(o+t.determine_size(n.keys(e)));return s(u+a(n.values(e)));case t.Rsrv.XT_ARRAY_STR|t.Rsrv.XT_HAS_ATTR:return t.determine_size("0403556553")+4+4+"class".length+3+t.determine_size(["javascript_function"]);default:throw new t.RserveError("Internal error, can't handle type "+i)}},t.write_into_view=function(e,r,a,s){var i,o,u,_,f=t.determine_size(e,a),l=f>16777215,c=a||t.type_id(e);l&&(c|=t.Rsrv.XT_LARGE);var R,v=r.data_view();switch(l?(R=8,v.setInt32(0,c+(f-8<<8)),v.setInt32(4,f-8>>>24)):(R=4,v.setInt32(0,c+(f-4<<8))),c&~t.Rsrv.XT_LARGE){case t.Rsrv.XT_NULL:break;case t.Rsrv.XT_ARRAY_BOOL:if(n.isBoolean(e))v.setInt32(R,1),v.setInt8(R+4,e?1:0);else for(v.setInt32(R,e.length),i=0;i<e.length;++i)v.setInt8(R+4+i,e[i]?1:0);break;case t.Rsrv.XT_ARRAY_STR:if(n.isArray(e)){var d=R;n.each(e,(function(e){for(var r=unescape(encodeURIComponent(e)),t=0;t<r.length;++t,++d)v.setUint8(d,r.charCodeAt(t));v.setUint8(d++,0)}))}else{var h=unescape(encodeURIComponent(e));for(i=0;i<h.length;++i)v.setUint8(R+i,h.charCodeAt(i));v.setUint8(R+h.length,0)}break;case t.Rsrv.XT_ARRAY_DOUBLE:if(n.isNumber(e))v.setFloat64(R,e);else for(i=0;i<e.length;++i)v.setFloat64(R+8*i,e[i]);break;case t.Rsrv.XT_RAW:for(_=new t.EndianAwareDataView(e),v.setUint32(R,e.byteLength),i=0;i<e.byteLength;++i)v.setUint8(R+4+i,_.getUint8(i));break;case t.Rsrv.XT_VECTOR:case t.Rsrv.XT_LANG_NOTAG:o=R,n.each(e,(function(e){var n=t.determine_size(e);t.write_into_view(e,r.skip(o),void 0,s),o+=n}));break;case t.Rsrv.XT_VECTOR|t.Rsrv.XT_HAS_ATTR:for(o=R+8,n.each(n.keys(e),(function(e){for(var r=0;r<e.length;++r,++o)v.setUint8(o,e.charCodeAt(r));v.setUint8(o++,0)})),v.setUint32(R+4,t.Rsrv.XT_ARRAY_STR+(o-(R+8)<<8)),v.setUint32(o,t.Rsrv.XT_SYMNAME+2048),o+=4,u="names",i=0;i<u.length;++i,++o)v.setUint8(o,u.charCodeAt(i));o+=3,v.setUint32(R,t.Rsrv.XT_LIST_TAG+(o-(R+4)<<8)),n.each(n.values(e),(function(e){var n=t.determine_size(e);t.write_into_view(e,r.skip(o),void 0,s),o+=n}));break;case t.Rsrv.XT_ARRAY_STR|t.Rsrv.XT_HAS_ATTR:var g=s(e);o=R+8;var T="javascript_function";for(i=0;i<T.length;++i,++o)v.setUint8(o,T.charCodeAt(i));for(v.setUint8(o++,0),v.setUint32(8,t.Rsrv.XT_ARRAY_STR+(o-(R+8)<<8)),v.setUint32(o,t.Rsrv.XT_SYMNAME+2048),o+=4,u="class",i=0;i<u.length;++i,++o)v.setUint8(o,u.charCodeAt(i));for(o+=3,v.setUint32(4,t.Rsrv.XT_LIST_TAG+(o-(R+4)<<8)),i=0;i<g.length;++i)v.setUint8(o+i,g.charCodeAt(i));v.setUint8(o+g.length,0);break;default:throw new t.RserveError("Internal error, can't handle type "+c)}},t);var r,t,n;module.exports=e;
